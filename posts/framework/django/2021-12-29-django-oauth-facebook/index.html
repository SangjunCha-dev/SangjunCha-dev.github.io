<!doctype html><html><head><title>Django 소셜로그인(oauth) facebook 연동</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><meta property="og:title" content="Django 소셜로그인(oauth) facebook 연동"><meta property="og:description" content="Django 소셜로그인(oauth) facebook 연동"><meta property="og:type" content="article"><meta property="og:url" content="https://sangjuncha-dev.github.io/posts/framework/django/2021-12-29-django-oauth-facebook/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-07T19:37:11+09:00"><meta property="article:modified_time" content="2022-01-07T19:37:11+09:00"><meta name=description content="Django 소셜로그인(oauth) facebook 연동"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Sangjun 개발 블로그</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>게시글</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/posts/algorithm/>algorithm</a><ul><li><a href=/posts/algorithm/leetcode/ title=leetcode>leetcode</a></li><li><a href=/posts/algorithm/programmers/ title=programmers>programmers</a></li></ul></li><li><a href=/posts/db/ title=db>db</a></li><li><a href=/posts/docker/ title=docker>docker</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/framework/>framework</a><ul class=active><li><a class=active href=/posts/framework/django/ title=django>django</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/os/>os</a><ul><li><a href=/posts/os/linux/ title=linux>linux</a></li><li><a href=/posts/os/windows/ title=windows>windows</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/programming/>programming</a><ul><li><a href=/posts/programming/golang/ title=golang>golang</a></li><li><a href=/posts/programming/python/ title=python>python</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://sangjuncha-dev.github.io/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/author_hubdaa05e9d050aba742615dd0c3c3a3a1_51368_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>차상준</h5><p>January 7, 2022</p></div><div class=title><h1>Django 소셜로그인(oauth) facebook 연동</h1></div><div class=post-content id=post-content><p>django restframework 기반의 페이스북(facebook) 인증 로그인 백엔드서버로 별도의 <code>auth</code>관련 라이브러리는 설치하지 않고 구현한다.</p><p><a href=https://developers.facebook.com/>페이스북 개발자 사이트</a>에서 사용하는 환경변수들이 등록되어있다는 가정하에 진행한다.</p><p>페이스북의 경우 다른 소셜로그인과는 용어나 흐름이 달라 추가로 설명하고 시작한다.</p><hr><h2 id=1-페이스북-auth-용어-및-각-페이지-설명>1. 페이스북 auth 용어 및 각 페이지 설명</h2><h3 id=11-graph-api-용어>1.1. Graph API 용어</h3><p>Graph API는 Facebook 플랫폼에서 데이터를 요청 및 응답받는 기본적인 수단이다. 프로그래밍 방식으로 데이터 쿼리, 새 스토리 게시, 광고 관리, 사진 업로드를 비롯한 다양한 작업을 수행할 수 있는 HTTP 기반 API이다.</p><p>Graph API는 노드, 에지 및 필드로 구성된다.</p><ul><li><code>노드</code> : 특정 개체에 대한 데이터 조회</li><li><code>에지</code> : 단일 개체에서 개체 컬렉션 조회</li><li><code>필드</code> : 컬렉션의 단일 개체 또는 각 개체에 대한 데이터 조회</li></ul><h4 id=111-http>1.1.1. HTTP</h4><p>모든 데이터 전송은 HTTP/1.1을 따르며 모든 엔드포인트에는 <code>HTTPS</code>가 필요하다.<br>Graph API는 HTTP 기반이므로 cURL, urllib 등 HTTP 라이브러리가 있는 모든 언어에서 사용할 수 있다. 즉 브라우저에서 직접 Graph API를 사용할 수 있다.</p><h4 id=112-호스트-url>1.1.2. 호스트 URL</h4><p>거의 모든 요청이 <code>graph.facebook.com</code> 호스트 URL에 전달된다.<br>한 가지 예외는 <code>graph-video.facebook.com</code>을 사용하는 동영상 업로드이다.</p><h4 id=113-노드>1.1.3. 노드</h4><p><code>노드</code>는 고유 ID를 갖는 개별 개체이다.<br>각각 Facebook의 사용자를 나타내는 고유한 ID를 갖는 수많은 사용자 노드 개체가 있고, 페이지, 그룹, 게시물, 사진 및 댓글은 Facebook 소셜 Graph에서 사용하는 노드의 일부이다.</p><p>사용자 노드에 대한 호출</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -i -X GET <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;https://graph.facebook.com/USER-ID?access_token=ACCESS-TOKEN&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{  
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Your Name&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;YOUR-USER-ID&#34;</span>  
</span></span><span style=display:flex><span>}  
</span></span></code></pre></div><h4 id=114-me>1.1.4. /me</h4><p><code>/me</code> 노드는 현재 API 호출을 보내는 데 사용하는 액세스 토큰을 보유한 사용자나 페이지의 개체 ID로 변환하는 특수한 엔드포인트이다. 사용자 액세스 토큰이 있으면 다음을 사용하여 사용자 이름과 ID를 가져올 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -i -X GET <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;https://graph.facebook.com/me?access_token=ACCESS-TOKEN&#34;</span>
</span></span></code></pre></div><h4 id=115-필드>1.1.5. 필드</h4><p>필드는 노드 속성이다. 노드나 에지를 쿼리하면 기본적으로 필드 세트가 반환된다. 하지만 <code>fields</code> 매개변수에 각 필드를 나열하여 반환할 필드를 지정하면 지정한 필드와 (항상 반환되는)개체의 ID만 반환된다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -i -X GET <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;https://graph.facebook.com/USER-ID?fields=id,name,email&amp;access_token=ACCESS-TOKEN&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;USER-ID&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;EXAMPLE NAME&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;EXAMPLE@EMAIL.COM&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=116-버전>1.1.6. 버전</h4><p>Graph API는 분기별로 릴리스되어 여러 버전이 있다. 예를 들어 버전 12.0을 호출하는 방법은 다음과 같다.<br>버전 명시 없이 호출할 경우 가장 오래된 버전으로 호출된다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -i -X GET <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;https://graph.facebook.com/v12.0/USER-ID/photos
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ?access_token=ACCESS-TOKEN&#34;</span>
</span></span></code></pre></div><h4 id=117-graph-테스트-url>1.1.7. Graph 테스트 URL</h4><p><a href=https://developers.facebook.com/tools/explorer>Graph Explorer</a></p><hr><h3 id=12-로그인-직접-빌드하기>1.2. 로그인 직접 빌드하기</h3><h4 id=121-로그인-대화-상자-호출-및-리디렉션-url-설정>1.2.1. 로그인 대화 상자 호출 및 리디렉션 URL 설정</h4><pre tabindex=0><code>https://www.facebook.com/v12.0/dialog/oauth?
  client_id={app-id}
  &amp;redirect_uri={redirect-uri}
  &amp;state={state-param}
</code></pre><p>필수 매개변수</p><ul><li>client_id : 앱 대시보드에서 볼수 있는 앱 ID</li><li>redirect_uri : 사용자가 다시 로그인하도록 리디렉션할 URL</li><li>state : 요청과 콜백 사이의 상태를 유지하기 위해 앱에서 생성한 문자열 값, 사이트 간 요청 위조를 방지하는 데 사용</li></ul><p>선택적 매개변수</p><ul><li>response_type : 앱으로 다시 리디렉션할 때 포함된 응답 데이터가 URL 매개변수인지 프래그먼트인지 결정<ul><li>code : 응답 데이터는 URL 매개변수로 포함되어 있으며, code 매개변수(각 로그인 요청에 고유한 암호화된 문자열)를 포함<ul><li>response query_string 값을 <code>callbackurl/?code=</code> 형식으로 받는다.</li></ul></li><li>token : 응답 데이터는 URL 프래그먼트로 포함되어 있으며, 액세스 토큰을 포함<ul><li>response query_string 값을 <code>callbackurl/?#access_token=</code> 형식으로 받는다.</li></ul></li><li>code%20token : 응답 데이터는 URL 프래그먼트로 포함되어 있으며, 액세스 토큰과 code 매개변수를 모두 포함<ul><li>response query_string 값을 <code>callbackurl/?#access_token=&code=</code> 형식으로 받는다.</li></ul></li><li>granted_scopes : 사용자가 로그인 시점에 앱에 부여한 모든 권한의 쉼표로 구분한 리스트를 반환</li></ul></li><li>scope : 앱 사용자에게 요청할 권한의 쉼표 또는 공백으로 구분한 리스트</li></ul><p>예시코드에서는 <code>response_type=code</code> 형식을 사용한다.</p><h4 id=122-id-확인>1.2.2. ID 확인</h4><ul><li>code : 수신하면 엔드포인트를 사용하여 액세스 토큰과 교환해야 한다. 호출에는 앱 시크릿 코드가 포함되므로 서버 간 호출이어야 한다.</li><li>token : 수신한 후 인증해야 한다. 토큰을 생성할 대상 사용자와 대상 앱을 표시하도록 검사 엔드포인트로 API 호출을 보내야 한다.</li><li>code와 token을 모두 수신했을 때는 두 단계를 모두 실행해야 한다.</li></ul><h4 id=123-액세스-토큰-발급>1.2.3. 액세스 토큰 발급</h4><p>액세스 토큰은 앱에서 Graph API 호출에 사용된다.</p><ol><li><p>요청</p><pre tabindex=0><code>GET https://graph.facebook.com/v12.0/oauth/access_token?
  client_id={app-id}
  &amp;redirect_uri={redirect-uri}
  &amp;client_secret={app-secret}
  &amp;code={code-parameter}
</code></pre><p>필수 매개변수</p><ul><li>client_id : 앱 ID</li><li>redirect_uri : OAuth 로그인 절차를 시작할 때 사용하는 원본 request_uri와 동일해야 한다.</li><li>client_secret : 고유한 앱 시크릿 코드이며, 앱 대시보드에 표시된다.</li><li>code : 위의 로그인 대화 상자 리디렉션에서 수신한 매개변수.</li></ul></li><li><p>응답</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;access_token&#34;</span>: <span style=color:#e6db74>&#34;{access-token}&#34;</span>, 
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;token_type&#34;</span>: <span style=color:#e6db74>&#34;{type}&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expires_in&#34;</span>:  <span style=color:#e6db74>&#34;{seconds-til-expiration}&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><h4 id=124-앱-액세스-토큰-발급>1.2.4. 앱 액세스 토큰 발급</h4><p>서버에서 Facebook API 요청할 떄 사용한다.</p><pre tabindex=0><code>&#34;https://graph.facebook.com/oauth/access_token
  ?client_id={your-app-id}
  &amp;client_secret={your-app-secret}
  &amp;grant_type=client_credentials&#34;
</code></pre><p>다른 방법으로 앱 액세스 토큰을 사용하지 않아도 되는 다른 방법으로 그래프 API를 호출할 수 있다.</p><p>호출할 때 앱 ID와 앱 시크릿 코드만 access_token 매개변수로 전달할 수 있다.</p><pre tabindex=0><code>&#34;https://graph.facebook.com/{api-endpoint}&amp;access_token={your-app_id}|{your-app_secret}&#34;
</code></pre><h4 id=125-액세스-토큰-검사>1.2.5. 액세스 토큰 검사</h4><p>response_type 유형으로 사용하는지 여부와 관계없이 액세스 토큰을 처리해야 한다.</p><p>요청</p><pre tabindex=0><code>GET graph.facebook.com/debug_token?
   input_token={token-to-inspect}
   &amp;access_token={app-token-or-admin-token}
</code></pre><p>매개변수</p><ul><li>input_token : 검사해야 할 토큰</li><li>access_token : 앱 개발자의 액세스 토큰 또는 앱 액세스 토큰</li></ul><p>응답</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;app_id&#34;</span>: <span style=color:#ae81ff>138483919580948</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;USER&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;application&#34;</span>: <span style=color:#e6db74>&#34;Social Cafe&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;expires_at&#34;</span>: <span style=color:#ae81ff>1352419328</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;is_valid&#34;</span>: <span style=color:#66d9ef>true</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;issued_at&#34;</span>: <span style=color:#ae81ff>1347235328</span>, 
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;sso&#34;</span>: <span style=color:#e6db74>&#34;iphone-safari&#34;</span>
</span></span><span style=display:flex><span>    }, 
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;scopes&#34;</span>: [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;email&#34;</span>, 
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;publish_actions&#34;</span>
</span></span><span style=display:flex><span>    ], 
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;user_id&#34;</span>: <span style=color:#e6db74>&#34;1207059&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>서버에서 app_id 값 비교를 통해 유효한 액세스 토큰인지 확인할 수 있다.</p><hr><h2 id=2-facebook-로그인-변수-설정>2. Facebook 로그인 변수 설정</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FACEBOOK_CONFIG <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;FACEBOOK_APP_ID&#34;</span>: APP_ID,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;FACEBOOK_REDIRECT_URI&#34;</span>: REDIRECT_URI,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;FACEBOOK_APP_SECRET_CODE&#34;</span>: APP_SECRET_CODE
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;STATE&#34;</span> : 임의의 랜덤코드,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>facebook_graph_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://graph.facebook.com/v12.0&#34;</span>
</span></span><span style=display:flex><span>facebook_login_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://www.facebook.com/v12.0/dialog/oauth&#34;</span>
</span></span><span style=display:flex><span>facebook_token_url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>facebook_graph_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/oauth/access_token&#34;</span>  
</span></span><span style=display:flex><span>facebook_debug_token_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://graph.facebook.com/debug_token&#34;</span>
</span></span><span style=display:flex><span>facebook_profile_url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>facebook_graph_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/me&#34;</span>  <span style=color:#75715e># 사용자 정보 요청</span>
</span></span></code></pre></div><p>FACEBOOK_REDIRECT_URI: https://localhost 리디렉션은 개발 모드에 있는 동안만 기본으로 허용된다.</p><h2 id=21-facebook-developers-계정-등록-및-app-id-구성-및-편집>2.1. Facebook Developers 계정 등록 및 APP ID 구성 및 편집</h2><h3 id=211-facebook-developers-계정-등록>2.1.1. Facebook Developers 계정 등록</h3><p><img src="../images/django-oauth-facebook/oauth_facebook-1.png?raw=true" alt></p><p><a href=https://developers.facebook.com/>페이스북 개발자 사이트</a>에서 페이스북 로그인후 개발자 계정에 가입한다.</p><p><img src="../images/django-oauth-facebook/oauth_facebook-2.png?raw=true" alt></p><p>이메일 인증받을 주소를 입력한다. (기본값 페이스북에 등록된 이메일)</p><p><img src="../images/django-oauth-facebook/oauth_facebook-3.png?raw=true" alt></p><p>관심사를 선택한다.</p><h3 id=212-app-생성>2.1.2. APP 생성</h3><p><img src="../images/django-oauth-facebook/oauth_facebook-4.png?raw=true" alt></p><p>앱을 생성한다.</p><p><img src="../images/django-oauth-facebook/oauth_facebook-5.png?raw=true" alt></p><p>페이스북 소셜 로그인 연동을 위해 생성할 앱으로 <code>소비자</code> 유형을 선택한다.</p><p><img src="../images/django-oauth-facebook/oauth_facebook-6.png?raw=true" alt></p><p>표시이름: 사용자가 앱에 로그인할 표시될 앱이름을 설정한다.</p><h3 id=212-앱-로그인-설정>2.1.2. 앱 로그인 설정</h3><p>앱 대시보드에서 APP ID를 확인할 수 있다.</p><p><img src="../images/django-oauth-facebook/oauth_facebook-8.png?raw=true" alt></p><p>앱에 <code>Facebook 로그인</code> 설정한다.</p><p><img src="../images/django-oauth-facebook/oauth_facebook-9.png?raw=true" alt></p><p>로그인할 플랫폼 유형 <code>웹</code>을 선택한다.</p><p><img src="../images/django-oauth-facebook/oauth_facebook-10.png?raw=true" alt></p><p>리다이렉트 URI를 사용하는 <code>사이트 주소</code>를 입력한다.</p><p><img src="../images/django-oauth-facebook/oauth_facebook-11.png?raw=true" alt></p><p>Facebook 로그인 → 설정 → 유효한 OAuth <code>리디렉션 URI</code>를 입력한다.</p><ul><li>리디렉션 URI: 페이스북 로그인 정보를 전송받을 URI</li><li>URI 리디렉션 유효성 검사기: 실제 웹서버와 통신이 되는지 검증한다.</li></ul><p><img src="../images/django-oauth-facebook/oauth_facebook-12.png?raw=true" alt></p><p><code>public_profile</code> 권한 설정에관한 경고문이 나올경우 <code>Get Advanced Access</code> 메뉴로 간다.</p><p><img src="../images/django-oauth-facebook/oauth_facebook-13.png?raw=true" alt></p><p><code>public_profile</code> 권한에서 <code>고급 엑세스 이용하기</code>로 이동한다.</p><p><img src="../images/django-oauth-facebook/oauth_facebook-14.png?raw=true" alt></p><p>고급 엑세스에 대한 개인정보 이용에 <code>동의</code>를 한다.</p><hr><h2 id=3-facebook-로그인-페이지>3. Facebook 로그인 페이지</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FacebookLoginView</span>(APIView):
</span></span><span style=display:flex><span>    permission_classes <span style=color:#f92672>=</span> (AllowAny,)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self, reqeust):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        facebook code 요청
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        client_id <span style=color:#f92672>=</span> FACEBOOK_CONFIG[<span style=color:#e6db74>&#39;FACEBOOK_APP_ID&#39;</span>]
</span></span><span style=display:flex><span>        redirect_uri <span style=color:#f92672>=</span> FACEBOOK_CONFIG[<span style=color:#e6db74>&#39;FACEBOOK_REDIRECT_URI&#39;</span>]
</span></span><span style=display:flex><span>        state <span style=color:#f92672>=</span> FACEBOOK_CONFIG[<span style=color:#e6db74>&#39;STATE&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        uri <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>facebook_login_url<span style=color:#e6db74>}</span><span style=color:#e6db74>?client_id=</span><span style=color:#e6db74>{</span>client_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;redirect_uri=</span><span style=color:#e6db74>{</span>redirect_uri<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;state=</span><span style=color:#e6db74>{</span>state<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;response_type=code&amp;scope=email%20public_profile&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        res <span style=color:#f92672>=</span> redirect(uri)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> res
</span></span></code></pre></div><p>uri 파라미터 설명</p><ul><li><p>필수 매개변수</p><ul><li>client_id : 앱 대시보드에서 볼수 있는 앱 ID</li><li>redirect_uri : 페이스북 로그인 정보를 전송받을 URI</li><li>state : 요청과 콜백 사이의 상태를 유지하기 위해 앱에서 생성한 문자열 값, 사이트 간 요청 위조를 방지하는 데 사용</li></ul></li><li><p>선택적 매개변수</p><ul><li>response_type : 앱으로 다시 리디렉션할 때 포함된 응답 데이터가 URL 매개변수인지 프래그먼트인지 결정<ul><li>code : 응답 데이터는 URL 매개변수로 포함되어 있으며, code 매개변수(각 로그인 요청에 고유한 암호화된 문자열)를 포함</li></ul></li><li>scope : 앱 사용자에게 요청할 권한의 쉼표 또는 공백으로 구분한 리스트</li></ul></li></ul><hr><h2 id=4-facebook-callback-함수>4. Facebook Callback 함수</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FacebookCallbackView</span>(APIView):
</span></span><span style=display:flex><span>    permission_classes <span style=color:#f92672>=</span> (AllowAny,)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@swagger_auto_schema</span>(query_serializer<span style=color:#f92672>=</span>CallbackUserInfoSerializer)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self, request):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        facebook access_token 요청 및 user_info 요청
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>query_params<span style=color:#f92672>.</span>copy()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        code <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;code&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> code:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Response(status<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_400_BAD_REQUEST)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        query_string <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;client_id&#39;</span>: FACEBOOK_CONFIG[<span style=color:#e6db74>&#39;FACEBOOK_APP_ID&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;redirect_uri&#39;</span>: FACEBOOK_CONFIG[<span style=color:#e6db74>&#39;FACEBOOK_REDIRECT_URI&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;client_secret&#39;</span>: FACEBOOK_CONFIG[<span style=color:#e6db74>&#39;FACEBOOK_APP_SECRET&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;code&#39;</span>: code,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        token_res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(facebook_token_url, params<span style=color:#f92672>=</span>query_string)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        token_json <span style=color:#f92672>=</span> token_res<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>        access_token <span style=color:#f92672>=</span> token_json<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;access_token&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> access_token:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Response(status<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_400_BAD_REQUEST)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 엑세스 토큰 검사 및 계정 정보 조회</span>
</span></span><span style=display:flex><span>        query_string <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;input_token&#39;</span>: access_token,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;access_token&#39;</span>: <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>FACEBOOK_CONFIG[<span style=color:#e6db74>&#39;FACEBOOK_APP_ID&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>|</span><span style=color:#e6db74>{</span>FACEBOOK_CONFIG[<span style=color:#e6db74>&#39;FACEBOOK_APP_SECRET&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        user_info_res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(facebook_debug_token_url, params<span style=color:#f92672>=</span>query_string)
</span></span><span style=display:flex><span>        user_info_json <span style=color:#f92672>=</span> user_info_res<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        facebook_account <span style=color:#f92672>=</span> user_info_json<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;data&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>not</span> facebook_account) <span style=color:#f92672>or</span> (<span style=color:#f92672>not</span> facebook_account<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;is_valid&#39;</span>)):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Response(status<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_400_BAD_REQUEST)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        user_id <span style=color:#f92672>=</span> facebook_account<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;user_id&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        query_string <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;fields&#39;</span>: <span style=color:#e6db74>&#39;email&#39;</span>, <span style=color:#75715e># email,name 형식으로 사용가능</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;access_token&#39;</span>: access_token,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        user_profile_res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(facebook_profile_url, params<span style=color:#f92672>=</span>query_string)
</span></span><span style=display:flex><span>        user_profile_json <span style=color:#f92672>=</span> user_profile_res<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        social_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;facebook&#39;</span>
</span></span><span style=display:flex><span>        social_id <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>social_type<span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#e6db74>{</span>user_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        user_email <span style=color:#f92672>=</span> user_profile_json<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;email&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 회원가입 및 로그인 처리 알고리즘 추가필요
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 테스트 값 확인용</span>
</span></span><span style=display:flex><span>        res <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;social_type&#39;</span>: social_type,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;social_id&#39;</span>: social_id,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;user_email&#39;</span>: user_email,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> Response(status<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_200_OK)
</span></span><span style=display:flex><span>        response<span style=color:#f92672>.</span>data <span style=color:#f92672>=</span> res
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> res
</span></span></code></pre></div><hr><h2 id=5-데이터-삭제-요청-콜백>5. 데이터 삭제 요청 콜백</h2><p>사용자 데이터에 액세스하는 앱은 사용자가 데이터 삭제를 요청할 방법을 제공해야 한다.</p><p>데이터 삭제 콜백은 앱 사용자가 앱을 삭제하고 데이터 삭제를 요청할 때마다 호출된다.</p><h3 id=51-콜백-구현>5.1. 콜백 구현</h3><p>앱의 앱 대시보드에 있는 Facebook 로그인 > 설정 페이지의 데이터 삭제 요청 URL 필드에 등록되어야 한다.</p><p>URL이 포함된 JSON 응답이 반환되며, 이 URL을 통해 사용자가 삭제 요청의 상태와 영숫자 인증 코드를 확인할 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;&lt;url&gt;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;confirmation_code&#34;</span>: <span style=color:#e6db74>&#34;&lt;code&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=6-로그인>6. 로그인</h2><p>웹서버에서 설정한 apple oauth 로그인 페이지로 접근하면 사전에 설정한 애플 리다이렉트 URI로 접근하는데 설정에 문제가 없다면 아래와 같은 로그인 페이지로 접속된다.</p><hr><h2 id=참고reference>참고(Reference)</h2><ul><li><a href=https://developers.facebook.com/docs/facebook-login/manually-build-a-login-flow/#login>로그인 플로 직접 빌드</a></li><li><a href=https://developers.facebook.com/docs/facebook-login/access-tokens>액세스 토큰</a></li></ul><ul><li><a href=https://developers.facebook.com/docs/graph-api/overview>Graph API 개요</a></li><li><a href=https://developers.facebook.com/docs/graph-api/get-started>Graph API 시작하기</a></li><li><a href=https://developers.facebook.com/docs/graph-api/reference/user/>Graph API User</a></li><li><a href=https://developers.facebook.com/docs/development/create-an-app/app-dashboard/data-deletion-callback>데이터 삭제 요청 콜백</a></li><li><a href=https://developers.facebook.com/docs/facebook-login/web/permissions>웹용 Facebook 로그인의 권한 관리</a></li></ul></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/SangjunCha-dev/sangjuncha-dev.github.io/edit/main/content/posts/framework/django/2021-12-29-Django-oauth-facebook.md title="이 페이지를 개선" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
이 페이지를 개선</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">목차</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#1-페이스북-auth-용어-및-각-페이지-설명>1. 페이스북 auth 용어 및 각 페이지 설명</a><ul><li><a href=#11-graph-api-용어>1.1. Graph API 용어</a><ul><li><a href=#111-http>1.1.1. HTTP</a></li><li><a href=#112-호스트-url>1.1.2. 호스트 URL</a></li><li><a href=#113-노드>1.1.3. 노드</a></li><li><a href=#114-me>1.1.4. /me</a></li><li><a href=#115-필드>1.1.5. 필드</a></li><li><a href=#116-버전>1.1.6. 버전</a></li><li><a href=#117-graph-테스트-url>1.1.7. Graph 테스트 URL</a></li></ul></li><li><a href=#12-로그인-직접-빌드하기>1.2. 로그인 직접 빌드하기</a><ul><li><a href=#121-로그인-대화-상자-호출-및-리디렉션-url-설정>1.2.1. 로그인 대화 상자 호출 및 리디렉션 URL 설정</a></li><li><a href=#122-id-확인>1.2.2. ID 확인</a></li><li><a href=#123-액세스-토큰-발급>1.2.3. 액세스 토큰 발급</a></li><li><a href=#124-앱-액세스-토큰-발급>1.2.4. 앱 액세스 토큰 발급</a></li><li><a href=#125-액세스-토큰-검사>1.2.5. 액세스 토큰 검사</a></li></ul></li></ul></li><li><a href=#2-facebook-로그인-변수-설정>2. Facebook 로그인 변수 설정</a></li><li><a href=#21-facebook-developers-계정-등록-및-app-id-구성-및-편집>2.1. Facebook Developers 계정 등록 및 APP ID 구성 및 편집</a><ul><li><a href=#211-facebook-developers-계정-등록>2.1.1. Facebook Developers 계정 등록</a></li><li><a href=#212-app-생성>2.1.2. APP 생성</a></li><li><a href=#212-앱-로그인-설정>2.1.2. 앱 로그인 설정</a></li></ul></li><li><a href=#3-facebook-로그인-페이지>3. Facebook 로그인 페이지</a></li><li><a href=#4-facebook-callback-함수>4. Facebook Callback 함수</a></li><li><a href=#5-데이터-삭제-요청-콜백>5. 데이터 삭제 요청 콜백</a><ul><li><a href=#51-콜백-구현>5.1. 콜백 구현</a></li></ul></li><li><a href=#6-로그인>6. 로그인</a></li><li><a href=#참고reference>참고(Reference)</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>바로가기</h5><ul><li class=nav-item><a class=smooth-scroll href=https://sangjuncha-dev.github.io#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://sangjuncha-dev.github.io#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://sangjuncha-dev.github.io#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:sangjuncha.dev@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>sangjuncha.dev@gmail.com</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">Copyright 2020. SangjunCha all rights reserved.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>