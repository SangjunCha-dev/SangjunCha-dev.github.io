<!doctype html><html><head><title>Django 소셜로그인(oauth) apple 연동</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><meta property="og:title" content="Django 소셜로그인(oauth) apple 연동"><meta property="og:description" content="Django oauth apple login"><meta property="og:type" content="article"><meta property="og:url" content="https://sangjuncha-dev.github.io/posts/framework/django/2021-12-28-django-oauth-apple/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-28T19:37:11+09:00"><meta property="article:modified_time" content="2021-12-28T19:37:11+09:00"><meta name=description content="Django oauth apple login"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Sangjun 개발 블로그</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>게시글</a></li><div class=subtree><li><a href=/posts/db/ title=db>db</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/devops/>devops</a><ul><li><a href=/posts/devops/docker/ title=docker>docker</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/framework/>framework</a><ul class=active><li><a class=active href=/posts/framework/django/ title=django>django</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/os/>os</a><ul><li><a href=/posts/os/linux/ title=linux>linux</a></li><li><a href=/posts/os/windows/ title=windows>windows</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/programming/>programming</a><ul><li><a href=/posts/programming/golang/ title=golang>golang</a></li><li><a href=/posts/programming/python/ title=python>python</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/algorithm/>algorithm</a><ul><li><a href=/posts/algorithm/leetcode/ title=leetcode>leetcode</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://sangjuncha-dev.github.io/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/author_hubdaa05e9d050aba742615dd0c3c3a3a1_51368_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>차상준</h5><p>December 28, 2021</p></div><div class=title><h1>Django 소셜로그인(oauth) apple 연동</h1></div><div class=post-content id=post-content><p>django restframework 기반의 애플(apple) 인증 로그인 백엔드서버로 별도의 <code>auth</code>관련 라이브러리는 설치하지 않고 구현한다.</p><p><a href=https://developer.apple.com/>애플 개발자 사이트</a>에서 사용하는 환경변수들이 등록되어있다는 가정하에 진행한다.</p><hr><h2 id=1-라이브러리-설치>1. 라이브러리 설치</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pip install django
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># restframework</span>
</span></span><span style=display:flex><span>$ pip install djangorestframework
</span></span><span style=display:flex><span>$ pip install djangorestframework-simplejwt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># pyjwt[crypto]</span>
</span></span><span style=display:flex><span>$ pip install pyjwt<span style=color:#f92672>[</span>crypto<span style=color:#f92672>]</span>
</span></span></code></pre></div><hr><h2 id=2-apple-로그인-변수-설정>2. Apple 로그인 변수 설정</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>APPLE_CONFIG <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;APPLE_TEAM_ID&#34;</span>: TEAM_ID,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;APPLE_CLIENT_ID&#34;</span>: 모바일 로그인시 Bundle ID <span style=color:#f92672>or</span> 웹 로그인시 Service ID,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;APPLE_REDIRECT_URI&#34;</span>: <span style=color:#e6db74>&#34;https://domain/REDIRECT_URI&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;APPLE_KEY_ID&#34;</span>: KEY_ID,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;APPLE_KEY_PATH&#34;</span>: <span style=color:#e6db74>&#34;./AuthKey_KEY_ID.p8&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;APPLE_PRIVATE_KEY&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apple_key_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(CONFIG_BASE_DIR, <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;./</span><span style=color:#e6db74>{</span>APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_KEY_PATH&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(apple_key_path, <span style=color:#e6db74>&#39;r&#39;</span>) <span style=color:#66d9ef>as</span> apple_key_file:
</span></span><span style=display:flex><span>    APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_PRIVATE_KEY&#39;</span>] <span style=color:#f92672>=</span> apple_key_file<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apple_base_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://appleid.apple.com&#34;</span>
</span></span><span style=display:flex><span>apple_auth_url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>apple_base_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/auth/authorize&#34;</span>
</span></span><span style=display:flex><span>apple_token_url <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>apple_base_url<span style=color:#e6db74>}</span><span style=color:#e6db74>/auth/token&#34;</span>
</span></span></code></pre></div><ul><li>APPLE_REDIRECT_URI: https 프로토콜을 사용하는 도메인 주소만 사용가능하다.(localhost 또는 IP주소는 사용할 수 없다.)</li><li><code>apple_auth_url</code>: 로그인 페이지 주소</li><li><code>apple_token_url</code>: ID 토큰 발급받기 위한 주소</li></ul><h3 id=21-app-id구성-및-편집>2.1. APP ID구성 및 편집</h3><p><a href="https://help.apple.com/developer-account/?lang=ko#/devde676e696">APP ID구성 및 편집</a></p><h4 id=211-certificates-identifiers--profiles>2.1.1. Certificates, Identifiers & Profiles</h4><p><img src="../images/django-oauth-apple/oauth_apple-1.png?raw=true" alt></p><ul><li>Description: 사용자가 로그인시 보여줄 사이트 이름등을 작성한다.</li><li>App Id Prefix: 애플 로그인시 필요한 Team ID</li><li>Bundle ID: 모바일 애플 로그인시 필요한 값이다.</li></ul><h4 id=212-server-to-server-notification-endpoint>2.1.2. Server To Server Notification Endpoint</h4><p><img src="../images/django-oauth-apple/oauth_apple-2.png?raw=true" alt></p><ul><li>Notification Endpoint: 사용자가 애플의 정보를 업데이트 할때 서버에서 수신받을 path 설정이다.</li></ul><h4 id=213-edit-your-services-id-configuration>2.1.3. Edit your Services ID Configuration</h4><p><img src="../images/django-oauth-apple/oauth_apple-3.png?raw=true" alt></p><ul><li>Description: 사용자가 로그인시 보여줄 사이트 이름등을 작성한다.</li><li>Identifier: 웹 로그인 애플 로그인시 필요한 값이다.</li></ul><h4 id=214-view-key-details>2.1.4. View Key Details</h4><p><img src="../images/django-oauth-apple/oauth_apple-5.png?raw=true" alt></p><ul><li>Key ID: 애플로그인시 사용할 개인키 값이다.<ul><li>우측 상단에서 <code>AuthKey_개인키.p8</code> key 파일을 다운받을 수 있으며 해당 키값을 별도의 설정파일에 넣거나 혹은 불러오는 식으로 사용하면 된다.</li><li>현재 위의 예시 코드는 개인키 파일을 불러오는 방법을 사용하였다.</li></ul></li></ul><hr><h2 id=3-apple-로그인-페이지>3. Apple 로그인 페이지</h2><p>사용자가 로그인 테스트 서버로 접속시 redirect URI를 반환한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppleLoginView</span>(APIView):
</span></span><span style=display:flex><span>    permission_classes <span style=color:#f92672>=</span> (AllowAny,)
</span></span><span style=display:flex><span>    authentication_classes <span style=color:#f92672>=</span> ()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self, reqeust):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        apple code 요청
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        client_id <span style=color:#f92672>=</span> APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_CLIENT_ID&#39;</span>]
</span></span><span style=display:flex><span>        redirect_uri <span style=color:#f92672>=</span> APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_REDIRECT_URI&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        uri <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>apple_auth_url<span style=color:#e6db74>}</span><span style=color:#e6db74>?client_id=</span><span style=color:#e6db74>{</span>client_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;&amp;redirect_uri=</span><span style=color:#e6db74>{</span>redirect_uri<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;response_type=code&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        res <span style=color:#f92672>=</span> redirect(uri)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> res
</span></span></code></pre></div><p>uri 파라미터 설명</p><ul><li>client_id : 모바일 로그인시 Bundle ID, 웹 로그인시 Service ID를 사용한다.</li><li>redirect_uri : APPLE 로그인 정보를 전송받을 URI</li><li>response_type : code, id_token 옵션이 있다.<ul><li>&ldquo;code&rdquo; or &ldquo;code id_token&rdquo; 2가지 유형만 사용가능하다.</li><li>입력값의 구분은 " " 공백으로 한다.</li></ul></li><li>scope : email, name 옵션이 있다.<ul><li><code>scope</code> 요청하였을 경우 response_mode는 <code>form_post</code>를 사용해야한다.</li></ul></li><li>response_mode : 응답 형식 지정<ul><li>form_post<ul><li>Method : <code>POST</code></li><li>Content-Type : <code>application/x-www-form-urlencoded</code></li><li>RestAPI 서버로 요청 처리할 경우 <code>415 Unsupported Media Type</code> 에러가 발생한다.</li></ul></li><li>지정하지 않을 경우<ul><li>Method : <code>GET</code></li><li>Content-Type : <code>application/json</code></li><li>RestAPI 서버로 요청 처리할 경우 response_mode 지정하지 않고 사용해야 한다.</li></ul></li></ul></li></ul><p>Content-Type 설명</p><ul><li>html form 태그를 사용하여 post 방식으로 요청하거나, jQuery의 ajax 등의 요청을 할때 default Content-Type은 <code>application/x-www-form-urlencoded</code> 이다.</li><li>RestAPI의 경우 보통 JSON(<code>application/json</code>)타입으로 요청 처리한다.</li><li>415 Unsupported Media Type 에러가 발생한 경우 위와 같이 Content-type이 일치하지 않을때 발생한다.</li></ul><hr><h2 id=4-apple-callback-함수>4. Apple Callback 함수</h2><p>사용자가 oauth 로그인시 code 검증 및 로그인 처리한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppleCallbackView</span>(APIView):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_key_and_secret</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        CLIENT_SECRET 생성       
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;alg&#39;</span>: <span style=color:#e6db74>&#39;ES256&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;kid&#39;</span>: APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_KEY_ID&#39;</span>],
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        payload <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;iss&#39;</span>: APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_TEAM_ID&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;iat&#39;</span>: time<span style=color:#f92672>.</span>time(),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;exp&#39;</span>: time<span style=color:#f92672>.</span>time() <span style=color:#f92672>+</span> <span style=color:#ae81ff>600</span>,  <span style=color:#75715e># 인증유효기간 10분</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;aud&#39;</span>: apple_base_url,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;sub&#39;</span>: APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_CLIENT_ID&#39;</span>],
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        client_secret <span style=color:#f92672>=</span> jwt<span style=color:#f92672>.</span>encode(
</span></span><span style=display:flex><span>            payload<span style=color:#f92672>=</span>payload, 
</span></span><span style=display:flex><span>            key<span style=color:#f92672>=</span>APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_PRIVATE_KEY&#39;</span>], 
</span></span><span style=display:flex><span>            algorithm<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ES256&#39;</span>, 
</span></span><span style=display:flex><span>            headers<span style=color:#f92672>=</span>headers
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> client_secret
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self, request):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        apple id_token 요청 및 user_info 조회
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>query_params<span style=color:#f92672>.</span>copy()
</span></span><span style=display:flex><span>        code <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;code&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e># id_token 서명을 에러로 인해 검증할 수 없어 자체 발급한 id_token 사용</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># CLIENT_SECRET 생성</span>
</span></span><span style=display:flex><span>        client_secret <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>get_key_and_secret()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;Content-type&#39;</span>: <span style=color:#e6db74>&#34;application/x-www-form-urlencoded&#34;</span>}
</span></span><span style=display:flex><span>        request_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;client_id&#39;</span>: APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_CLIENT_ID&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;client_secret&#39;</span>: client_secret,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;code&#39;</span>: code,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;grant_type&#39;</span>: <span style=color:#e6db74>&#39;authorization_code&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;redirect_uri&#39;</span>: APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_REDIRECT_URI&#39;</span>],
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># client_secret 유효성 검사</span>
</span></span><span style=display:flex><span>        res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(apple_token_url, data<span style=color:#f92672>=</span>request_data, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>        response_json <span style=color:#f92672>=</span> res<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>        id_token <span style=color:#f92672>=</span> response_json<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;id_token&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> id_token:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Response(status<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_400_BAD_REQUEST)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 백엔드 자체적으로 id_token 발급받은 경우 서명을 검증할 필요 없음</span>
</span></span><span style=display:flex><span>        token_decode <span style=color:#f92672>=</span> jwt<span style=color:#f92672>.</span>decode(id_token, <span style=color:#e6db74>&#39;&#39;</span>, options<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;verify_signature&#34;</span>: <span style=color:#66d9ef>False</span>})
</span></span><span style=display:flex><span>        <span style=color:#75715e># sub : (subject) is the unique user id</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># email : is the email address of the user</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>not</span> token_decode<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;sub&#39;</span>)) <span style=color:#f92672>or</span> (<span style=color:#f92672>not</span> token_decode<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;email&#39;</span>)) <span style=color:#f92672>or</span> (<span style=color:#f92672>not</span> token_decode<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;email_verified&#39;</span>)):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Response(status<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_400_BAD_REQUEST)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Apple에서 받은 id_token에서 sub, email 조회</span>
</span></span><span style=display:flex><span>        social_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;apple&#39;</span>
</span></span><span style=display:flex><span>        social_id <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>social_type<span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#e6db74>{</span>token_decode[<span style=color:#e6db74>&#39;sub&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        user_email <span style=color:#f92672>=</span> token_decode[<span style=color:#e6db74>&#39;email&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # 회원가입 및 로그인 처리 알고리즘 추가필요
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 테스트 값 확인용</span>
</span></span><span style=display:flex><span>        res <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;social_type&#39;</span>: social_type,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;social_id&#39;</span>: social_id,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;user_email&#39;</span>: user_email,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> Response(status<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_200_OK)
</span></span><span style=display:flex><span>        response<span style=color:#f92672>.</span>data <span style=color:#f92672>=</span> res
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span></code></pre></div><ul><li>id_token 검증하려고 할 경우 &lsquo;_EllipticCurvePrivateKey&rsquo; object has no attribute &lsquo;verify&rsquo; 에러가 발생한다.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>token <span style=color:#f92672>=</span> jwt<span style=color:#f92672>.</span>decode(id_token, key<span style=color:#f92672>=</span>APPLE_CONFIG[<span style=color:#e6db74>&#39;APPLE_PRIVATE_KEY&#39;</span>], algorithms<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;RS256&#39;</span>)
</span></span></code></pre></div></li></ul><p>id_token 복호화시 아래의 값들이 있다.</p><ul><li>iss</li><li>aud</li><li>exp</li><li>iat</li><li>sub : 사용자 고유식별자</li><li>at_hash</li><li>email : 사용자 email or 임의의코드@privaterelay.appleid.com</li><li>email_verified : 이메일 인증여부</li><li>auth_time</li></ul><hr><h2 id=5-로그인>5. 로그인</h2><ol><li><p>웹서버에서 설정한 apple oauth 로그인 페이지로 접근하면 사전에 설정한 애플 리다이렉트 URI로 접근하는데 설정에 문제가 없다면 아래와 같은 로그인 페이지로 접속된다.</p><ul><li>로그인 페이지에서는 어떤 사이트로 로그인할지 같이 안내한다.</li><li>애플 개발자 사이트에서 설정한 <code>Description</code>값이 노출된다.</li></ul><p><img src="../images/django-oauth-apple/login-1.png?raw=true" alt></p></li><li><p>최초 로그인시 아래와 같이 안내되고 이후는 Apple Callback 함수 처리로 넘어간다.</p><p><img src="../images/django-oauth-apple/login-2.png?raw=true" alt></p></li></ol><hr><h2 id=6-예시-코드-git>6. 예시 코드 Git</h2><ul><li><a href=https://github.com/SangjunCha-dev/django_oauth>django_oauth</a></li></ul><hr><h2 id=참고reference>참고(Reference)</h2><ul><li><a href=https://developer.okta.com/blog/2019/06/04/what-the-heck-is-sign-in-with-apple>What the Heck is Sign In with Apple?</a></li><li><a href=https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_js/configuring_your_webpage_for_sign_in_with_apple>configuring_your_webpage_for_sign_in_with_apple</a><ul><li>Handle the Authorization Response</li></ul></li><li><a href=https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens>generate_and_validate_tokens</a></li><li><a href=https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_js/incorporating_sign_in_with_apple_into_other_platforms>incorporating_sign_in_with_apple_into_other_platforms</a><ul><li>Send the Required Query Parameters</li></ul></li></ul></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/SangjunCha-dev/sangjuncha-dev.github.io/edit/main/content/posts/framework/django/2021-12-28-Django-oauth-apple.md title="이 페이지를 개선" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
이 페이지를 개선</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">목차</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#1-라이브러리-설치>1. 라이브러리 설치</a></li><li><a href=#2-apple-로그인-변수-설정>2. Apple 로그인 변수 설정</a><ul><li><a href=#21-app-id구성-및-편집>2.1. APP ID구성 및 편집</a><ul><li><a href=#211-certificates-identifiers--profiles>2.1.1. Certificates, Identifiers & Profiles</a></li><li><a href=#212-server-to-server-notification-endpoint>2.1.2. Server To Server Notification Endpoint</a></li><li><a href=#213-edit-your-services-id-configuration>2.1.3. Edit your Services ID Configuration</a></li><li><a href=#214-view-key-details>2.1.4. View Key Details</a></li></ul></li></ul></li><li><a href=#3-apple-로그인-페이지>3. Apple 로그인 페이지</a></li><li><a href=#4-apple-callback-함수>4. Apple Callback 함수</a></li><li><a href=#5-로그인>5. 로그인</a></li><li><a href=#6-예시-코드-git>6. 예시 코드 Git</a></li><li><a href=#참고reference>참고(Reference)</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>바로가기</h5><ul><li class=nav-item><a class=smooth-scroll href=https://sangjuncha-dev.github.io#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://sangjuncha-dev.github.io#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://sangjuncha-dev.github.io#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:sangjuncha.dev@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>sangjuncha.dev@gmail.com</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">Copyright 2020. SangjunCha all rights reserved.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>