<!doctype html><html><head><title>도커 경량화 이미지 만들기</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><meta property="og:title" content="도커 경량화 이미지 만들기"><meta property="og:description" content="도커 경량화 이미지 만들기"><meta property="og:type" content="article"><meta property="og:url" content="https://sangjuncha-dev.github.io/posts/devops/docker/2021-12-21-docker-reduce-the-volume/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-21T11:24:13+09:00"><meta property="article:modified_time" content="2021-12-21T11:24:13+09:00"><meta name=description content="도커 경량화 이미지 만들기"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Sangjun 개발 블로그</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>게시글</a></li><div class=subtree><li><a href=/posts/db/ title=db>db</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/devops/>devops</a><ul class=active><li><a class=active href=/posts/devops/docker/ title=docker>docker</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/framework/>framework</a><ul><li><a href=/posts/framework/django/ title=django>django</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/os/>os</a><ul><li><a href=/posts/os/linux/ title=linux>linux</a></li><li><a href=/posts/os/windows/ title=windows>windows</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/programming/>programming</a><ul><li><a href=/posts/programming/golang/ title=golang>golang</a></li><li><a href=/posts/programming/python/ title=python>python</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/algorithm/>algorithm</a><ul><li><a href=/posts/algorithm/leetcode/ title=leetcode>leetcode</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://sangjuncha-dev.github.io/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/author_hubdaa05e9d050aba742615dd0c3c3a3a1_51368_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>차상준</h5><p>December 21, 2021</p></div><div class=title><h1>도커 경량화 이미지 만들기</h1></div><div class=post-content id=post-content><hr><p>Docker Image 경량화의 장점</p><ul><li>저장공간 절약</li><li>이미지 빌드 및 배포시간 단축</li><li>클라우드 서비스를 이용한 배포의 경우 비용 절약</li></ul><hr><h2 id=1-가벼운-base-image-사용>1. 가벼운 Base image 사용</h2><p>Base image에는 사용하지 않은 기능들이 포함되어 있기때문에 Debian계열과 Alpine 계열등 다양한 Base image를 사용하여 용량을 줄일 수 있다.</p><ul><li>단, 필요한 패키지나 파일이 없어 별도의 설치가 필요할 수 있다.</li></ul><p>기본 python 이미지와 slim형 이미지를 각각 빌드한다.</p><p>image-test1</p><pre tabindex=0><code>FROM python:3.8.10
</code></pre><p>image-test2</p><pre tabindex=0><code>FROM python:3.8.10-slim-buster
</code></pre><p>각각 빌드된 이미지 크기는 다음과 같다.</p><pre tabindex=0><code># docker images
REPOSITORY       TAG       IMAGE ID       CREATED         SIZE
image-test1    latest    3249573f28c9   5 months ago    883MB
image-test2    latest    004c04ba9ac3   2 months ago    114MB
</code></pre><p><code>python:3.8.10-slim-buster</code></p><ul><li>postgreDB 라이브러리 사용할 경우 <code>psycopg2</code>가 아닌 <code>psycopg2-binary</code>를 사용해야한다.</li><li>libmagic 라이브러리 사용할 경우 별도로 <code>libmagic1</code>설치가 필요하다.<pre tabindex=0><code>RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends libmagic1 &amp;&amp; rm -rf /var/lib/apt/lists/*
</code></pre></li></ul><hr><h2 id=2-dockerfile-명령어-체인방식-사용>2. Dockerfile 명령어 체인방식 사용</h2><p>Dockerfile에서 RUN명령을 개별로 실행시 실행이 끝날때마다 중간 이미지가 생성된다.<br>체인 명령으로 실행하면 중간이미지가 적게 만들어지기 때문에 크기와 실행시간을 줄일 수 있다.</p><ul><li>현재 Docker 버전에서의 영향은 미미하다.</li></ul><p>Dockerfile 개별 실행 명령</p><pre tabindex=0><code>ENV APP_HOME=/app
RUN mkdir $APP_HOME
RUN mkdir $APP_HOME/.static_root 
RNU mkdir $APP_HOME/media
</code></pre><p>Dockerfile 체인 실행 명령</p><pre tabindex=0><code>ENV APP_HOME=/app
RUN mkdir $APP_HOME &amp;&amp; mkdir $APP_HOME/.static_root &amp;&amp; mkdir $APP_HOME/media
</code></pre><hr><h2 id=3-패키지-관리>3. 패키지 관리</h2><p>Package 매니저로 패키지를 설치할 경우 보통 사용하지않은 패키지가 함께 설치된다.</p><p>apt-get 사용하여 패키지 설치시 용량을 최소화 하는 방법</p><ul><li>&ndash;no-install-recommends 최소 설치 옵션을 사용한다.<pre tabindex=0><code>apt-get install -y --no-install-recommends cron
</code></pre></li><li>apt-get clean 명령어 사용한다.<ul><li>/var/cache/apt/archives 디렉터리에 패키지 다운로드한 파일 삭제</li></ul><pre tabindex=0><code>apt-get clean
</code></pre></li><li>/var/lib/pat/lists 디렉터리의 패키지 리스트 파일 삭제<pre tabindex=0><code>rm -rf /var/lib/apt/lists/*
</code></pre></li></ul><hr><h2 id=4-docker-layer-관리>4. Docker Layer 관리</h2><p>Docker Image에는 Layer라는 Stack구조가 있다. 도커 이미지를 효과적으로 관리하기 위해 Stack형태로 이미지가 누적되며, 동일한 Stack이 동일한 Repository에 존재하면 해당 Layer를 사용하도록 구현되어 있다.
Docker Image는 Container 용량을 결정하고, 관리측면에서 Local Repository나 Docker Registry의 용량에 영향을 준다.</p><ul><li>Dockerfile 작성 시 라이브러리 설치 등 수정이 적은 명령어를 상단에 프로젝트 코드 등 데이터 수정이 빈번한 명령어는 하단에 작성하면 이미지 중복 생성을 최소화할 수 있다.</li></ul><p>image-test1</p><pre tabindex=0><code>FROM debian
RUN apt-get update &amp;&amp; apt-get install -y cron
RUN rm -rf /var/lib/apt/lists/*
</code></pre><p>image-test2</p><pre tabindex=0><code>FROM debian
RUN apt-get update &amp;&amp; apt-get install -y cron &amp;&amp; rm -rf /var/lib/apt/lists/*
</code></pre><p>각각 빌드된 이미지 크기는 다음과 같다.</p><pre tabindex=0><code># docker images
REPOSITORY    TAG       IMAGE ID       CREATED            SIZE
image-test1   latest    211a762c5a58   2 minutes ago      230MB
image-test2   latest    297340498b12   1 minutes ago      213MB
</code></pre><p>동일한 명령을 수행하여도 차이가 나는 이유는 <code>Layer별 참조 관계</code> 때문이다.
따라서 사용하지 않고 삭제가 필요한 경우에는 반드시 같은 Layer에서 처리해야 한다.</p><p>Docker Layer는 Union Mount라는 Linux Mount 기술을 활용하여 여러 Layer를 통합하여 하나의 이미지로 관리한다.</p><h3 id=docker-layer-별-용량-확인>Docker Layer 별 용량 확인</h3><p><code>docker history [IMAGE]</code> : 해당 Docker 이미지의 각 layer마다 사용된 용량을 확인할 수 있다.</p><pre tabindex=0><code># docker history [IMAGE]
...
IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT
148db3ce1bdc   16 minutes ago   RUN /bin/sh -c apt-get update &amp;&amp; apt-get ins…   2.24MB    buildkit.dockerfile.v0
&lt;missing&gt;      2 weeks ago      /bin/sh -c #(nop)  CMD [&#34;python3&#34;]              0B
&lt;missing&gt;      2 weeks ago      /bin/sh -c set -ex;   wget -O get-pip.py &#34;$P…   8.31MB
&lt;missing&gt;      2 weeks ago      /bin/sh -c #(nop)  ENV PYTHON_GET_PIP_SHA256…   0B
&lt;missing&gt;      2 weeks ago      /bin/sh -c #(nop)  ENV PYTHON_GET_PIP_URL=ht…   0B
&lt;missing&gt;      2 weeks ago      /bin/sh -c #(nop)  ENV PYTHON_SETUPTOOLS_VER…   0B
&lt;missing&gt;      2 weeks ago      /bin/sh -c #(nop)  ENV PYTHON_PIP_VERSION=21…   0B
...
</code></pre><p><code>--no-trunc</code>옵션 : CREATED BY 설명의 생략된 부분까지 확인 할 수 있다.</p><pre tabindex=0><code># docker history --no-trunc [IMAGE]
</code></pre><hr><h2 id=5-배포-시-불필요한-빌드-도구를-설치하지-않기>5. 배포 시 불필요한 빌드 도구를 설치하지 않기</h2><p>소스코드를 빌드해서 이미지에 포함시키면, 불필요한 빌드 도구가 차지하는 공간을 줄일 수 있다.</p><hr><h2 id=6-dockerignore-활용하기>6. .dockerignore 활용하기</h2><p>Docker build 시 명령어 COPY 등을 통해서 프로젝트 파일을 컨테이너로 복사할 때 지정한 디렉터리, 파일을 자동으로 제외된다.</p><ul><li>Docker는 Go 언어기반으로 파일 매칭도 Go 언어규칙을 적용한다.</li><li>임시파일, Git, Docker 관련, 비공개 정보 파일 등 예외 처리한다.</li><li>docker volumes 참조와 겹치지 않도록 한다.(volumes 우선적용)</li></ul><hr><h2 id=7-multi-stage-빌드>7. multi-stage 빌드</h2><p>multi-stage 빌드는 Dockerfile 1개에 FROM 구문을 여러 개 두는 방식이다.<br>각 FROM 명령문 기준으로 스테이지를 구분하여 특정 스테이지 빌드 과정에서 생성된 것 중 사용되지 않거나 불필요한 것을 무시하고, 필요한 부분만 가져와서 새로운 베이스 이미지에서 빌드할 수 있다.</p><ul><li><code>COPY --from=builder</code> : 전 단계 스테이지 빌드에서 생성된 특정 결과물을 새로운 베이스 이미지로 복사하는 옵션</li></ul><p>image-test1</p><pre tabindex=0><code>FROM python:3.8.10-slim-buster
RUN pip install django
</code></pre><p>image-test2</p><pre tabindex=0><code>FROM python:3.8.10-slim-buster AS builder
RUN pip install django

FROM python:3.8.10-slim-buster
COPY --from=builder /usr/local/lib/python3.8/site-packages /usr/local/lib/python3.8/site-packages
</code></pre><p>각각 빌드된 이미지 크기는 다음과 같다.</p><pre tabindex=0><code># docker images
REPOSITORY     TAG       IMAGE ID       CREATED         SIZE
image-test1    latest    62fad51305c5   2 minutes ago   155MB
image-test2    latest    004c04ba9ac3   1 minutes ago   151MB
</code></pre><ul><li>사용하는 라이브러리에 따라 용량 차이가 더 많이 나올 수 있다.</li><li>외부 설정이 까다로운 경우에는 multi-stage를 사용하지 않을 수 있다.</li></ul><hr><h2 id=참고reference>참고(Reference)</h2><ul><li><a href=https://waspro.tistory.com/692>컨테이너 이미지 생성시 고려사항</a></li><li><a href=https://velog.io/@idnnbi/Docker-image-%ED%81%AC%EA%B8%B0-%EC%A4%84%EC%9D%B4%EA%B8%B0>Docker - image 크기 줄이기</a></li><li><a href=https://pythonspeed.com/articles/alpine-docker-python/>Alpine을 사용하면 Python Docker를 50배 더 느리게 만들 수 있다.</a></li><li><a href=https://jonnung.dev/docker/2020/04/08/optimizing-docker-images/>도커 이미지 잘 만드는 방법</a></li></ul></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/SangjunCha-dev/sangjuncha-dev.github.io/edit/main/content/posts/devops/docker/2021-12-21-Docker-reduce-the-volume.md title="이 페이지를 개선" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
이 페이지를 개선</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">목차</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#1-가벼운-base-image-사용>1. 가벼운 Base image 사용</a></li><li><a href=#2-dockerfile-명령어-체인방식-사용>2. Dockerfile 명령어 체인방식 사용</a></li><li><a href=#3-패키지-관리>3. 패키지 관리</a></li><li><a href=#4-docker-layer-관리>4. Docker Layer 관리</a><ul><li><a href=#docker-layer-별-용량-확인>Docker Layer 별 용량 확인</a></li></ul></li><li><a href=#5-배포-시-불필요한-빌드-도구를-설치하지-않기>5. 배포 시 불필요한 빌드 도구를 설치하지 않기</a></li><li><a href=#6-dockerignore-활용하기>6. .dockerignore 활용하기</a></li><li><a href=#7-multi-stage-빌드>7. multi-stage 빌드</a></li><li><a href=#참고reference>참고(Reference)</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>바로가기</h5><ul><li class=nav-item><a class=smooth-scroll href=https://sangjuncha-dev.github.io#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://sangjuncha-dev.github.io#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:sangjuncha.dev@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>sangjuncha.dev@gmail.com</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">Copyright 2020. SangjunCha all rights reserved.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>