<!doctype html><html>
<head>
<title>golang 도커 이미지 만들기</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<link rel=stylesheet href=/css/bootstrap.min.css>
<link rel=stylesheet href=/css/layouts/main.css>
<link rel=stylesheet href=/css/navigators/navbar.css>
<link rel=stylesheet href=/css/plyr.css>
<link rel=stylesheet href=/css/flag-icon.min.css>
<link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css>
<meta property="og:title" content="golang 도커 이미지 만들기">
<meta property="og:description" content="golang docker image build">
<meta property="og:type" content="article">
<meta property="og:url" content="https://sangjuncha-dev.github.io/posts/docker/2021-12-22-docker-golang-image-build/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-22T15:22:06+09:00">
<meta property="article:modified_time" content="2021-12-22T15:22:06+09:00">
<meta name=description content="golang docker image build">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css>
<link rel=stylesheet href=/css/layouts/single.css>
<link rel=stylesheet href=/css/navigators/sidebar.css>
<link rel=stylesheet href=/css/style.css>
</head>
<body data-spy=scroll data-target=#TableOfContents data-offset=80>
<div class="container-fluid bg-dimmed wrapper">
<nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
<div class=container>
<button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span>
</button>
<a class=navbar-brand href=/>
Sangjun 개발 블로그</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse lang-selector" id=top-nav-items>
<ul class="navbar-nav ml-auto">
</ul>
</div>
</div>
</nav>
<section class=sidebar-section id=sidebar-section>
<div class=sidebar-holder>
<div class=sidebar id=sidebar>
<form class=mx-auto method=get action=/search>
<input type=text name=keyword placeholder=Search data-search id=search-box>
</form>
<div class=sidebar-tree>
<ul class=tree id=tree>
<li id=list-heading><a href=/posts data-filter=all>게시글</a></li>
<div class=subtree>
<li>
<i class="fas fa-plus-circle"></i><a href=/posts/algorithm/>algorithm</a>
<ul>
<li><a href=/posts/algorithm/leetcode/ title=leetcode>leetcode</a></li>
<li><a href=/posts/algorithm/programmers/ title=programmers>programmers</a></li>
</ul>
</li>
<li><a href=/posts/db/ title=db>db</a></li>
<li><a class=active href=/posts/docker/ title=docker>docker</a></li>
<li>
<i class="fas fa-plus-circle"></i><a href=/posts/framework/>framework</a>
<ul>
<li><a href=/posts/framework/django/ title=django>django</a></li>
</ul>
</li>
<li>
<i class="fas fa-plus-circle"></i><a href=/posts/os/>os</a>
<ul>
<li><a href=/posts/os/linux/ title=linux>linux</a></li>
<li><a href=/posts/os/windows/ title=windows>windows</a></li>
</ul>
</li>
<li>
<i class="fas fa-plus-circle"></i><a href=/posts/programming/>programming</a>
<ul>
<li><a href=/posts/programming/golang/ title=golang>golang</a></li>
<li><a href=/posts/programming/python/ title=python>python</a></li>
</ul>
</li>
</div>
</ul>
</div>
</div>
</div>
</section>
<section class=content-section id=content-section>
<div class=content>
<div class="container p-0 read-area">
<div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://sangjuncha-dev.github.io/images/default-hero.jpg)>
</div>
<div class=page-content>
<div class="author-profile ml-auto align-self-lg-center">
<img class=rounded-circle src=/images/author/author_hubdaa05e9d050aba742615dd0c3c3a3a1_51368_120x120_fit_box_3.png alt="Author Image">
<h5 class=author-name>Sangjun</h5>
<p>December 22, 2021</p>
</div>
<div class=title>
<h1>golang 도커 이미지 만들기</h1>
</div>
<div class=post-content id=post-content>
<p>간단한 golang 웹 프로그램을 Docker 이미지로 실행방법으로<br>
golang 코드보다는 docker 설정 위주로 설명한다.</p>
<h2 id=예제-코드>예제 코드</h2>
<p>사용예시는 아래의 주소를 git clone 받는다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; git clone https://github.com/olliefr/docker-gs-ping
</code></pre></div><ul>
<li><a href=https://github.com/olliefr/docker-gs-ping>docker-gs-ping</a></li>
</ul>
<h2 id=예제-프로그램-실행>예제 프로그램 실행</h2>
<p>git clone 받은 프로젝트 경로에서 터미널을 실행하고 진행한다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; go run main.go
</code></pre></div><p></p>
<p>설정한 웹주소로 접속 요청시 간단한 response 메세지를 응답한다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; curl localhost:8080
Hello, Docker! &lt;<span style=color:#ae81ff>3</span>
</code></pre></div><h2 id=dockerfile>Dockerfile</h2>
<p>dockerfile 명칭은 <code>Dockerfile.&lt;something></code> 또는 <code>&lt;something>.Dockerfile</code> 형식으로 생성한다.</p>
<p>도커 명령어</p>
<ul>
<li><code>FROM</code> : 기본 이미지 지정</li>
<li><code>WORKDIR</code> : 작업 디렉터리 지정</li>
<li><code>COPY</code> : 소스코드 복사
<ul>
<li><a href=https://docs.docker.com/engine/reference/builder/#copy>https://docs.docker.com/engine/reference/builder/#copy</a></li>
</ul>
</li>
<li><code>EXPOSE</code> : 도커 컨테이너의 Port 설정</li>
<li><code>RUN</code> : 새로운 도커 레이어를 생성하고 명령어를 실행한다. 패키지 설치 등에 사용된다.</li>
<li><code>CMD</code> : default 명령어나 파라미터를 설정한다. docker run 실행 시 실행할 명령어를 지정하지 않으면 default 명령이 실행된다.</li>
</ul>
<p>Dockerfile</p>
<pre tabindex=0><code>FROM golang:1.17-alpine

WORKDIR /app

# Go modules 다운로드
COPY go.mod .
COPY go.sum .
RUN go mod download

COPY *.go ./

# go build
RUN go build -o /docker-gs-ping

EXPOSE 8080

# go 프로그램 실행
CMD [&quot;/docker-gs-ping&quot;]
</code></pre><p></p>
<p>도커 이미지 빌드</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; docker build --tag docker-gs-ping .
</code></pre></div><p></p>
<p><code>docker image ls</code> : 도커 로컬이미지 조회</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; docker image ls
REPOSITORY       TAG      IMAGE ID       CREATED          SIZE
docker-gs-ping   latest   4f0670869ed5   <span style=color:#ae81ff>12</span> seconds ago   540MB
</code></pre></div><p></p>
<p><code>docker image tag</code> : 도커 이미지 태그 지정</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Usage:  docker image tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</span>
&gt; docker image tag docker-gs-ping:latest docker-gs-ping:v1.0
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; docker image ls
REPOSITORY       TAG      IMAGE ID       CREATED         SIZE
docker-gs-ping   latest   4f0670869ed5   <span style=color:#ae81ff>3</span> minutes ago   540MB
docker-gs-ping   v1.0     4f0670869ed5   <span style=color:#ae81ff>3</span> minutes ago   540MB
</code></pre></div><h2 id=multi-stage-builds>Multi-stage builds</h2>
<p>도커 이미지 용량 줄이는 방법 중 하나로 프로그램 실행에 필요한 파일들만으로 이미지를 생성하는 방법이다.</p>
<ul>
<li><code>FROM golang:1.16-buster AS build</code> : 해당 이미지 별명을 지정한다.</li>
<li><code>COPY --from=build [src_dir] [dst_dir]</code> : from으로 지정한 이미지의 디렉터리를 현재 이미지 디렉터리로 복사한다.</li>
<li><code>ENTRYPOINT</code> : 컨테이너를 실행 파일로 사용할 때 정의되어야 한다.<br>
사용법은 <code>CMD</code>와 같다.
<ul>
<li>CMD와 ENTRYPOINT의 조합 예시<br>
<a href=https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact>ENTRYPOINT / CMD combinations</a></li>
</ul>
</li>
<li><code>gcr.io/distroless/base-debian10</code> : go에서 공식 지원하는 도커 이미지로 bash와 같은 쉘 , linux 패키지 관리자, 기타 프로그램 등이 없는 경량화된 이미지이다.</li>
<li><code>USER nonroot:nonroot</code> : 컨테이너 권한 설정으로 도커 컨테이너는 기본적으로 root권한으로 실행된다.<br>
따라서 컨테이너 안에서 실행중인 애플리케이션을 해킹하면 해커들이 도커 호스트에 대한 루트권한을 얻을 수 있기 때문에 별도의 사용자권한으로 제한하는것을 권장한다.<br>
하지만 컨테이너 내부에서 외부 볼륨 참조에 의한 디렉터리 및 파일 등을 조작이 필요한 경우 적절한 권한으로 설정하거나 해당 USER 옵션을 사용하지 않을 수 있다.</li>
</ul>
<p>Dockerfile.multistage</p>
<pre tabindex=0><code>## Build
FROM golang:1.16-buster AS build

WORKDIR /app

COPY go.mod .
COPY go.sum .
RUN go mod download

COPY *.go ./

RUN go build -o /docker-gs-ping

## Deploy
FROM gcr.io/distroless/base-debian10

WORKDIR /
COPY --from=build /docker-gs-ping /docker-gs-ping

EXPOSE 8080
USER nonroot:nonroot

ENTRYPOINT [&quot;/docker-gs-ping&quot;]
</code></pre><p></p>
<p>도커 이미지 빌드</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; docker build -t docker-gs-ping:multistage -f Dockerfile.multistage .
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt;docker image ls
REPOSITORY       TAG          IMAGE ID       CREATED          SIZE
docker-gs-ping   multistage   04b0984d8007   <span style=color:#ae81ff>5</span> seconds ago    27.1MB      
docker-gs-ping   latest       4f0670869ed5   <span style=color:#ae81ff>13</span> minutes ago   540MB
</code></pre></div><h2 id=도커-컨테이너-실행>도커 컨테이너 실행</h2>
<ul>
<li><code>--publish</code> or <code>-p</code>: 외부 접속포트와 컨테이너포트를 연동시키는 명령이다.
<ul>
<li>-p [host_port]:[container_port]</li>
</ul>
</li>
<li><code>-d</code> : detached mode로 백그라운드에 실행 컨테이너가 실행된다.</li>
</ul>
<pre tabindex=0><code>&gt; docker run -d -p 8080:8080 docker-gs-ping
</code></pre><p></p>
<p><code>docker ps</code> : 도커 컨테이너 실행 확인</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; docker ps
CONTAINER ID   IMAGE            COMMAND             CREATED         STATUS         PORTS                    NAMES
4984da23dfa3   docker-gs-ping   <span style=color:#e6db74>&#34;/docker-gs-ping&#34;</span>   <span style=color:#ae81ff>8</span> minutes ago   Up <span style=color:#ae81ff>8</span> minutes   0.0.0.0:8080-&gt;8080/tcp   stoic_shaw
</code></pre></div><p></p>
<p>컨테이너가 정상적으로 실행되었다면 접속시 아래와 같은 응답 값을 받을 수 있다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; curl localhost:8080
Hello, Docker! &lt;<span style=color:#ae81ff>3</span>
</code></pre></div><h2 id=참조-url>참조 URL</h2>
<ul>
<li><a href=https://docs.docker.com/language/golang/build-images/>Docker docs Build your Go image</a></li>
</ul>
</div>
<div class="row pl-3 pr-3">
<div class="col-md-6 share-buttons">
</div>
<div class="col-md-6 btn-improve-page">
<a href=https://github.com/SangjunCha-dev/sangjuncha-dev.github.io/edit/main/content/posts/docker/2021-12-22-Docker-golang-image-build.md title="이 페이지를 개선" target=_blank rel=noopener>
<i class="fas fa-code-branch"></i>
이 페이지를 개선
</a>
</div>
</div>
<hr>
<div class="row next-prev-navigator">
</div>
<hr>
</div>
</div>
</div>
<a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a>
</section>
<section class=toc-section id=toc-section>
<div class=toc-holder>
<h5 class="text-center pl-3">목차</h5>
<hr>
<div class=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#예제-코드>예제 코드</a></li>
<li><a href=#예제-프로그램-실행>예제 프로그램 실행</a></li>
<li><a href=#dockerfile>Dockerfile</a></li>
<li><a href=#multi-stage-builds>Multi-stage builds</a></li>
<li><a href=#도커-컨테이너-실행>도커 컨테이너 실행</a></li>
<li><a href=#참조-url>참조 URL</a></li>
</ul>
</nav>
</div>
</div>
</section>
</div>
<footer class="container-fluid text-center align-content-center footer pb-2">
<div class="container pt-5">
<div class="row text-left">
<div class="col-md-4 col-sm-12">
<h5>바로가기</h5>
<ul>
<li class=nav-item>
<a class=smooth-scroll href=https://sangjuncha-dev.github.io#about>About</a>
</li>
<li class=nav-item>
<a class=smooth-scroll href=https://sangjuncha-dev.github.io#skills>Skills</a>
</li>
<li class=nav-item>
<a class=smooth-scroll href=https://sangjuncha-dev.github.io#recent-posts>Recent Posts</a>
</li>
</ul>
</div>
<div class="col-md-4 col-sm-12">
<h5>Contact me:</h5>
<ul>
<li><a href=mailto:sangjuncha.dev@gmail.com target=_blank rel=noopener>
<span><i class="fas fa-envelope"></i></span> <span>sangjuncha.dev@gmail.com</span>
</a></li>
</ul>
</div>
</div>
</div>
<hr>
<div class=container>
<div class="row text-left">
<div class=col-md-4>
<a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener>
<img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha
</a>
</div>
<div class="col-md-4 text-center">© 2020 Copyright.</div>
<div class="col-md-4 text-right">
<a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18>
</a>
</div>
</div>
</div>
</footer>
<script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>